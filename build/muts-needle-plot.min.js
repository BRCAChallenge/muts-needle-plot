!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.mutsNeedlePlot=e()}}(function(){var e;return function t(e,n,r){function o(s,a){if(!n[s]){if(!e[s]){var l="function"==typeof require&&require;if(!a&&l)return l(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var u=n[s]={exports:{}};e[s][0].call(u.exports,function(t){var n=e[s][1][t];return o(n?n:t)},u,u.exports,t,e,n,r)}return n[s].exports}for(var i="function"==typeof require&&require,s=0;s<r.length;s++)o(r[s]);return o}({1:[function(e,t){var n=e("backbone-events-standalone");n.onAll=function(e,t){return this.on("all",e,t),this},n.oldMixin=n.mixin,n.mixin=function(e){n.oldMixin(e);for(var t=["onAll"],r=0;r<t.length;r++){var o=t[r];e[o]=this[o]}return e},t.exports=n},{"backbone-events-standalone":3}],2:[function(t,n,r){!function(){function t(){return{keys:Object.keys||function(e){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError("keys() called on a non-object");var t,n=[];for(t in e)e.hasOwnProperty(t)&&(n[n.length]=t);return n},uniqueId:function(e){var t=++u+"";return e?e+t:t},has:function(e,t){return l.call(e,t)},each:function(e,t,n){if(null!=e)if(a&&e.forEach===a)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,o=e.length;o>r;r++)if(t.call(n,e[r],r,e)===s)return}else for(var i in e)if(this.has(e,i)&&t.call(n,e[i],i,e)===s)return},once:function(e){var t,n=!1;return function(){return n?t:(n=!0,t=e.apply(this,arguments),e=null,t)}}}}var o,i=this,s={},a=Array.prototype.forEach,l=Object.prototype.hasOwnProperty,c=Array.prototype.slice,u=0,d=t();o={on:function(e,t,n){if(!h(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,t,n){if(!h(this,"once",e,[t,n])||!t)return this;var r=this,o=d.once(function(){r.off(e,o),t.apply(this,arguments)});return o._callback=t,this.on(e,o,n)},off:function(e,t,n){var r,o,i,s,a,l,c,u;if(!this._events||!h(this,"off",e,[t,n]))return this;if(!e&&!t&&!n)return this._events={},this;for(s=e?[e]:d.keys(this._events),a=0,l=s.length;l>a;a++)if(e=s[a],i=this._events[e]){if(this._events[e]=r=[],t||n)for(c=0,u=i.length;u>c;c++)o=i[c],(t&&t!==o.callback&&t!==o.callback._callback||n&&n!==o.context)&&r.push(o);r.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=c.call(arguments,1);if(!h(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&g(n,t),r&&g(r,arguments),this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return this;var o=!t&&!n;"object"==typeof t&&(n=this),e&&((r={})[e._listenerId]=e);for(var i in r)r[i].off(t,n,this),o&&delete this._listeners[i];return this}};var f=/\s+/,h=function(e,t,n,r){if(!n)return!0;if("object"==typeof n){for(var o in n)e[t].apply(e,[o,n[o]].concat(r));return!1}if(f.test(n)){for(var i=n.split(f),s=0,a=i.length;a>s;s++)e[t].apply(e,[i[s]].concat(r));return!1}return!0},g=function(e,t){var n,r=-1,o=e.length,i=t[0],s=t[1],a=t[2];switch(t.length){case 0:for(;++r<o;)(n=e[r]).callback.call(n.ctx);return;case 1:for(;++r<o;)(n=e[r]).callback.call(n.ctx,i);return;case 2:for(;++r<o;)(n=e[r]).callback.call(n.ctx,i,s);return;case 3:for(;++r<o;)(n=e[r]).callback.call(n.ctx,i,s,a);return;default:for(;++r<o;)(n=e[r]).callback.apply(n.ctx,t)}},p={listenTo:"on",listenToOnce:"once"};d.each(p,function(e,t){o[t]=function(t,n,r){var o=this._listeners||(this._listeners={}),i=t._listenerId||(t._listenerId=d.uniqueId("l"));return o[i]=t,"object"==typeof n&&(r=this),t[e](n,r,this),this}}),o.bind=o.on,o.unbind=o.off,o.mixin=function(e){var t=["on","once","off","trigger","stopListening","listenTo","listenToOnce","bind","unbind"];return d.each(t,function(t){e[t]=this[t]},this),e},"function"==typeof e?e(function(){return o}):"undefined"!=typeof r?("undefined"!=typeof n&&n.exports&&(r=n.exports=o),r.BackboneEvents=o):i.BackboneEvents=o}(this)},{}],3:[function(e,t){t.exports=e("./backbone-events-standalone")},{"./backbone-events-standalone":2}],4:[function(t,n){!function(t,r){"function"==typeof e&&e.amd?e(["d3"],r):"object"==typeof n&&n.exports?n.exports=function(e){return e.tip=r(e),e.tip}:t.d3.tip=r(t.d3)}(this,function(e){return function(){function t(e){b=g(e),C=b.createSVGPoint(),document.body.appendChild(x)}function n(){return"n"}function r(){return[0,0]}function o(){return" "}function i(){var e=p();return{top:e.n.y-x.offsetHeight,left:e.n.x-x.offsetWidth/2}}function s(){var e=p();return{top:e.s.y,left:e.s.x-x.offsetWidth/2}}function a(){var e=p();return{top:e.e.y-x.offsetHeight/2,left:e.e.x}}function l(){var e=p();return{top:e.w.y-x.offsetHeight/2,left:e.w.x-x.offsetWidth}}function c(){var e=p();return{top:e.nw.y-x.offsetHeight,left:e.nw.x-x.offsetWidth}}function u(){var e=p();return{top:e.ne.y-x.offsetHeight,left:e.ne.x}}function d(){var e=p();return{top:e.sw.y,left:e.sw.x-x.offsetWidth}}function f(){var e=p();return{top:e.se.y,left:e.e.x}}function h(){var t=e.select(document.createElement("div"));return t.style({position:"absolute",top:0,opacity:0,"pointer-events":"none","box-sizing":"border-box"}),t.node()}function g(e){return e=e.node(),"svg"===e.tagName.toLowerCase()?e:e.ownerSVGElement}function p(){for(var t=w||e.event.target;"undefined"==typeof t.getScreenCTM&&"undefined"===t.parentNode;)t=t.parentNode;var n={},r=t.getScreenCTM(),o=t.getBBox(),i=o.width,s=o.height,a=o.x,l=o.y;return C.x=a,C.y=l,n.nw=C.matrixTransform(r),C.x+=i,n.ne=C.matrixTransform(r),C.y+=s,n.se=C.matrixTransform(r),C.x-=i,n.sw=C.matrixTransform(r),C.y-=s/2,n.w=C.matrixTransform(r),C.x+=i,n.e=C.matrixTransform(r),C.x-=i/2,C.y-=s/2,n.n=C.matrixTransform(r),C.y+=s,n.s=C.matrixTransform(r),n}var y=n,m=r,v=o,x=h(),b=null,C=null,w=null;t.show=function(){var n=Array.prototype.slice.call(arguments);n[n.length-1]instanceof SVGElement&&(w=n.pop());var r,o=v.apply(this,n),i=m.apply(this,n),s=y.apply(this,n),a=e.select(x),l=S.length,c=document.documentElement.scrollTop||document.body.scrollTop,u=document.documentElement.scrollLeft||document.body.scrollLeft;for(a.html(o).style({opacity:1,"pointer-events":"all"});l--;)a.classed(S[l],!1);return r=k.get(s).apply(this),a.classed(s,!0).style({top:r.top+i[0]+c+"px",left:r.left+i[1]+u+"px"}),t},t.hide=function(){var n=e.select(x);return n.style({opacity:0,"pointer-events":"none"}),t},t.attr=function(n){if(arguments.length<2&&"string"==typeof n)return e.select(x).attr(n);var r=Array.prototype.slice.call(arguments);return e.selection.prototype.attr.apply(e.select(x),r),t},t.style=function(n){if(arguments.length<2&&"string"==typeof n)return e.select(x).style(n);var r=Array.prototype.slice.call(arguments);return e.selection.prototype.style.apply(e.select(x),r),t},t.direction=function(n){return arguments.length?(y=null==n?n:e.functor(n),t):y},t.offset=function(n){return arguments.length?(m=null==n?n:e.functor(n),t):m},t.html=function(n){return arguments.length?(v=null==n?n:e.functor(n),t):v};var k=e.map({n:i,s:s,e:a,w:l,nw:c,ne:u,sw:d,se:f}),S=k.keys();return t}})},{}],5:[function(e,t){function n(t){function n(){var e=g.extent();needleHeads=d3.selectAll(".needle-head"),selectedNeedles=[],categCounts={};for(key in Object.keys(o.totalCategCounts))categCounts[key]=0;needleHeads.classed("selected",function(t){return is_brushed=e[0]<=t.coord&&t.coord<=e[1],is_brushed&&(selectedNeedles.push(t),categCounts[t.category]=(categCounts[t.category]||0)+t.value),is_brushed}),o.trigger("needleSelectionChange",{selected:selectedNeedles,categCounts:categCounts,coords:e})}function r(){get_button=d3.select(".clear-button"),o.trigger("needleSelectionChangeEnd",{selected:selectedNeedles,categCounts:categCounts,coords:g.extent()})}var o=this;if(this.maxCoord=t.maxCoord||-1,this.maxCoord<0)throw new Error("'maxCoord' must be defined initiation config!");if(this.minCoord=t.minCoord||1,mutationData=t.mutationData||-1,this.maxCoord<0)throw new Error("'mutationData' must be defined initiation config!");if(regionData=t.regionData||-1,this.maxCoord<0)throw new Error("'regionData' must be defined initiation config!");this.totalCategCounts={},this.categCounts={},this.selectedNeedles=[];var i=document.getElementById(t.targetElement)||t.targetElement||document.body,s=this.width=t.width||i.offsetWidth||1e3,a=this.height=t.height||i.offsetHeight||500;this.colorMap=t.colorMap||{};var l=Object.keys(this.colorMap).map(function(e){return o.colorMap[e]});this.colorScale=d3.scale.category20().domain(Object.keys(this.colorMap)).range(l.concat(d3.scale.category20().range())),this.legends=t.legends||{y:"Value",x:"Coordinate"},this.svgClasses="mutneedles",this.buffer=0;var c=(this.maxCoord,0);c=s>=a?a/8:s/8,this.buffer=c;var u=e("d3-tip");u(d3),this.tip=d3.tip().attr("class","d3-tip d3-tip-needle").offset([-10,0]).html(function(e){return"<span>"+e.value+" "+e.category+" at coord. "+e.coordString+"</span>"}),this.selectionTip=d3.tip().attr("class","d3-tip d3-tip-selection").offset([100,0]).html(function(e){return"<span> Selected coordinates<br/>"+Math.round(e.left)+" - "+Math.round(e.right)+"</span>"}).direction("n");var d=d3.select(i).append("svg").attr("width",s).attr("height",a).attr("class",this.svgClasses);d.call(this.tip),d.call(this.selectionTip);var f=d3.scale.linear().domain([this.minCoord,this.maxCoord]).range([1.5*c,s-c]).nice();this.x=f;var h=d3.scale.linear().domain([1,20]).range([a-1.5*c,c]).nice();this.y=h,o.selector=d3.svg.brush().x(f).on("brush",n).on("brushend",r);var g=o.selector;this.svgClasses+=" brush";var p=d.attr("class",this.svgClasses).call(g).selectAll(".extent").attr("height",a);p.on("mouseenter",function(){var e=g.extent();o.selectionTip.show({left:e[0],right:e[1]},p.node())}).on("mouseout",function(){d3.select(".d3-tip-selection").transition().delay(3e3).duration(1e3).style("opacity",0).style("pointer-events","none")}),this.drawNeedles(d,mutationData,regionData),o.on("needleSelectionChange",function(e){o.categCounts=e.categCounts,o.selectedNeedles=e.selected,d.call(verticalLegend)}),o.on("needleSelectionChangeEnd",function(e){o.categCounts=e.categCounts,o.selectedNeedles=e.selected,d.call(verticalLegend)}),o.on("needleSelectionChange",function(e){selection=e.coords,selection[1]-selection[0]>0?(o.selectionTip.show({left:selection[0],right:selection[1]},p.node()),d3.select(".d3-tip-selection").transition().delay(3e3).duration(1e3).style("opacity",0).style("pointer-events","none")):o.selectionTip.hide()})}n.prototype.drawLegend=function(e){self=this,mutCategories=[],categoryColors=[],allcategs=Object.keys(self.totalCategCounts),orderedDeclaration=self.colorScale.domain();for(idx in orderedDeclaration)r=orderedDeclaration[idx],allcategs.indexOf(r)>-1&&(mutCategories.push(r),categoryColors.push(self.colorScale(r)));mutsScale=self.colorScale.domain(mutCategories).range(categoryColors);var t=self.x.domain();xplacement=.75*(self.x(t[1])-self.x(t[0]))+self.x(t[0]);var n=0;for(var r in self.totalCategCounts)n+=self.totalCategCounts[r];legendLabel=function(e){var t=self.categCounts[e]||0==self.selectedNeedles.length&&self.totalCategCounts[e]||0;return e+(t>0?": "+t+" ("+Math.round(t/n*100)+"%)":"")},legendClass=function(e){var t=self.categCounts[e]||0==self.selectedNeedles.length&&self.totalCategCounts[e]||0;return t>0?"":"nomuts"},self.noshow=[];var o=d3.selectAll(".needle-head");showNoShow=function(e){_.contains(self.noshow,e)?self.noshow=_.filter(self.noshow,function(t){return t!=e}):self.noshow.push(e),o.classed("noshow",function(e){return _.contains(self.noshow,e.category)});var t=d3.selectAll("g.legendCells");t.classed("noshow",function(e){return _.contains(self.noshow,e.stop[0])})},verticalLegend=d3.svg.legend().labelFormat(legendLabel).labelClass(legendClass).onLegendClick(showNoShow).cellPadding(4).orientation("vertical").units(n+" Mutations").cellWidth(20).cellHeight(12).inputScale(mutsScale).cellStepping(4).place({x:xplacement,y:50}),e.call(verticalLegend)},n.prototype.drawRegions=function(e,t){function n(t){function n(e){var t=e.radius+3,n=e.x-t,r=e.x+t,o=e.y-t,i=e.y+t;return function(s,a,l,c,u){if(s.point&&s.point!==e){var d=e.x-s.point.x,f=d;t=e.radius+s.point.radius,Math.abs(d)<t&&(d=(d-t)/d*.005,f*=d,f=e.x>s.point.x&&0>f?-f:f,e.x+=f,s.point.x-=f)}return a>r||n>c||l>i||o>u}}var r=d3.select(".mutneedles").selectAll().data(["dummy"]).enter().insert("g",":first-child").attr("class","regionsBG").append("rect").attr("x",a(i)).attr("y",s(0)+c).attr("width",a(o)-a(i)).attr("height",10),l=r=d3.select(".mutneedles").selectAll().data(t).enter().append("g").attr("class","regionGroup");l.append("rect").attr("x",function(e){return a(e.start)}).attr("y",s(0)+u).attr("ry","3").attr("rx","3").attr("width",function(e){return a(e.end)-a(e.start)}).attr("height",16).style("fill",function(e){return e.color}).style("stroke",function(e){return d3.rgb(e.color).darker()}),l.attr("pointer-events","all").attr("cursor","pointer").on("click",function(e){self.selector.extent([e.start,e.end]),self.selector(d3.select(".brush").transition()),self.selector.event(d3.select(".brush").transition().delay(300))});var f=[],h={},g=function(e){var t="regionName",n="RR_"+e.name;return _.has(h,e.name)&&(t="repeatedName noshow "+n),h[e.name]=n,t};l.append("text").attr("class",g).attr("text-anchor","middle").attr("x",function(e){return e.x=a(e.start)+(a(e.end)-a(e.start))/2,e.x}).attr("y",function(e){return e.y=s(0)+d,e.y}).attr("dy","0.35em").style("font-size","12px").style("text-decoration","bold").text(function(e){return e.name});var p=d3.selectAll(".regionName");p.each(function(e){var t=this.getBBox().width/2;f.push({x:e.x,y:e.y,label:e.name,weight:e.name.length,radius:t})});var y=d3.layout.force().chargeDistance(5).nodes(f).charge(-10).gravity(0),m=(a(i),a(o),function(t){var n=h[t];e.selectAll("text."+n).attr("x",newx)});y.on("tick",function(){for(var t=d3.geom.quadtree(f),r=0,o=f.length;++r<o;)t.visit(n(f[r]));var r=0;e.selectAll("text.regionName").attr("x",function(e){return newx=f[r++].x,m(e.name,newx),newx})}),y.start()}function r(e){for(key in Object.keys(e))e[key].start=getRegionStart(e[key].coord),e[key].end=getRegionEnd(e[key].coord),e[key].color=getColor(e[key].name);return e}var o=this.maxCoord,i=this.minCoord,s=(this.buffer,this.colorMap,this.y),a=this.x,l=!0;getRegionStart=function(e){return parseInt(e.split("-")[0])},getRegionEnd=function(e){return parseInt(e.split("-")[1])},getColor=this.colorScale;var c=0,u=c-3,d=c+20;1!=l&&(d=c+5),"string"==typeof t?d3.json(t,function(e,t){return e?console.debug(e):(regionList=r(t),void n(regionList))}):(regionList=r(t),n(regionList))},n.prototype.drawAxes=function(e){var t=this.y,n=this.x;xAxis=d3.svg.axis().scale(n).orient("bottom"),e.append("svg:g").attr("class","x-axis").attr("transform","translate(0,"+(this.height-this.buffer)+")").call(xAxis),yAxis=d3.svg.axis().scale(t).orient("left"),e.append("svg:g").attr("class","y-axis").attr("transform","translate("+(1.2*this.buffer+-10)+",0)").call(yAxis),e.append("text").attr("class","y-label").attr("text-anchor","middle").attr("transform","translate("+this.buffer/3+","+this.height/2+"), rotate(-90)").text(this.legends.y),e.append("text").attr("class","x-label").attr("text-anchor","middle").attr("transform","translate("+this.width/2+","+(this.height-this.buffer/3)+")").text(this.legends.x)},n.prototype.drawNeedles=function(e,t,n){function r(e){return coordString=e.coord,numericCoord=formatCoord(e.coord),numericValue=Number(e.value),stickHeight=stackNeedle(numericCoord,numericValue,needlePoint),category=e.category||"other",stickHeight+numericValue>highest&&(highest=stickHeight+numericValue,getYAxis().domain([0,highest+2])),numericCoord>0?(l.totalCategCounts[category]=(l.totalCategCounts[category]||0)+numericValue,{category:category,coordString:coordString,coord:numericCoord,value:numericValue,stickHeight:stickHeight,color:l.colorScale(category)}):void console.debug("discarding "+e.coord+" "+e.category+"("+numericCoord+")")}function o(e){for(key in e)formatted=r(e[key]),void 0!=formatted&&c.push(formatted);return c}function i(t){minSize=4,maxSize=10,headSizeScale=d3.scale.log().range([minSize,maxSize]).domain([1,highest/2]);var r=function(e){return d3.min([d3.max([headSizeScale(e),minSize]),maxSize])},o=(d3.select(".mutneedles").selectAll().data(t).enter().append("line").attr("y1",function(e){return s(e.stickHeight+e.value)+r(e.value)}).attr("y2",function(e){return s(e.stickHeight)}).attr("x1",function(e){return a(e.coord)}).attr("x2",function(e){return a(e.coord)}).attr("class","needle-line"),d3.select(".mutneedles").selectAll().data(t).enter().append("circle").attr("cy",function(e){return s(e.stickHeight+e.value)}).attr("cx",function(e){return a(e.coord)}).attr("r",function(e){return r(e.value)}).attr("class","needle-head").style("fill",function(e){return e.color}).style("stroke",function(e){return d3.rgb(e.color).darker()}).on("mouseover",function(e){d3.select(this).moveToFront(),tip.show(e)}).on("mouseout",tip.hide));d3.selection.prototype.moveToFront=function(){return this.each(function(){this.parentNode.appendChild(this)})},void 0!=n&&l.drawRegions(e,n),l.drawLegend(e),l.drawAxes(e),o.each(function(){this.parentNode.appendChild(this)})}var s=this.y,a=this.x,l=this;getYAxis=function(){return s},formatCoord=function(e){return e.indexOf("-")>-1?(coords=e.split("-"),e=Math.floor((parseInt(coords[0])+parseInt(coords[1]))/2),isNaN(e)&&("?"==coords[0]?e=parseInt(coords[1]):"?"==coords[1]&&(e=parseInt(coords[0])))):e=parseInt(e),e},tip=this.tip,needlePoint={},highest=0,stackNeedle=function(e,t,n){return stickHeight=0,e="p"+String(e),e in n?(stickHeight=n[e],newHeight=stickHeight+t,n[e]=newHeight):n[e]=t,stickHeight};var c=[];"string"==typeof t?d3.json(t,function(e,t){if(e)throw new Error(e);c=o(t),i(c)}):(c=o(t),i(c))};var r=e("biojs-events");r.mixin(n.prototype),t.exports=n},{"biojs-events":1,"d3-tip":4}],"muts-needle-plot":[function(e,t){t.exports=e("./src/js/MutsNeedlePlot.js")},{"./src/js/MutsNeedlePlot.js":5}]},{},["muts-needle-plot"])("muts-needle-plot")});