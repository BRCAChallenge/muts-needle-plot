<!DOCTYPE html>
<meta charset="utf-8">
<style>

text {
  font: 12px sans-serif;
}

.needle-line {
    stroke: black;
    stroke-width= 5;
}

.regionsBG {
    fill: lightgrey;
}

.regionName {
      fill: black;
      font-weight: bold;
}

.x-axis path, .x-axis line, .y-axis path, .y-axis line {
      fill: none;
}

.domain { 
  fill: none; 
  stroke: black; 
  stroke-width; 1;
} 

.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.6);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script>

function MutNeedles (maxCoord, target, regionData, mutationData, colorMap) {

    this.width = width;
    this.height = height;
    this.maxCoord = maxCoord;
    this.buffer = 0;
    this.colorMap = {};
    if (colorMap != undefined) {
        this.colorMap=colorMap
    }

    var width = this.width = 1000;
    var height = this.height = 500;

    if (width >= height) {
      var buffer = height / 8;
    } else {
      var buffer = width / 8;
    }

    this.buffer = buffer;

    this.tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-10, 0])
      .html(function(d) {
        return "<span style='color:white'>" + d.value + " " + d.category +  " at " + d.coordString; + "</span>";
      })

    var svg = d3.select(target).append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("class", "mutneedles");

    svg.call(this.tip);


    d3.json(regionData, function(error, json) {
        if (error) {return console.debug(error)};
        regions = json;
        console.debug(regions);
    });


    // define scales

    var x = d3.scale.linear()
      .domain([1, maxCoord])
      .range([buffer, width - buffer * 1.5])
      .nice();

    var y = d3.scale.linear()
      .domain([1,20])
      .range([height - buffer * 1.5, buffer])
      .nice();
    
    this.drawAxes(svg, x, y);
    this.drawNeedleHeads(svg, mutationData, x, y);
    this.drawRegions(svg, regionData, x, y);

}

MutNeedles.prototype.drawRegions = function(svg, regionData, x, y) {

    var maxCoord = this.maxCoord;
    var buffer = this.buffer


    regionStart = function(region) {
        return parseInt(region.split("-")[0])
    }

    regionEnd = function(region) {
        return parseInt(region.split("-")[1])
    }


    var regionsBG = d3.select(".mutneedles").selectAll()
        .data([1]).enter()
        .append("rect")
          .attr("x", x(0) )
          .attr("y", y(0) + 10 )
          .attr("width", x(maxCoord) - x(0) )
          .attr("height", 10)
          .attr("class", "regionsBG");

    d3.json(regionData, function(error, regions) {
        if (error) {return console.debug(error)};

        regionList = [];
        i = 0;
        for (key in regions) {
            i++;
            regionList.push( {
                'name': key, 
                'start': regionStart(regions[key]),
                'end': regionEnd(regions[key]),
                'color': ["yellow", "orange", "lightgreen"][i%3]
            });
        }

        console.log(regionList);

        var regions = d3.select(".mutneedles").selectAll()
            .data(regionList)
          .enter()
          .append("g")
          .attr("class", "region");

        regions.append("rect")
              .attr("x", function(r) { return x(r.start) })
              .attr("y", y(0) + 7)
              .attr("width", function(r) { return x(r.end)-x(r.start) } )
              .attr("height", 16)
              .style("fill", function(data) {return data.color});
         
        regions.append("text")
           .attr("class", "regionName")
           .attr("text-anchor", "middle")
           .attr("x", function(r) { return  x(r.start)+(x(r.end)-x(r.start))/2 })
           .attr("y", y(0) + 16)
           .attr("dy", "0.35em")
           .style("font-size", "12px") 
           .style("text-decoration", "bold")
           .text(function(data) { return data.name } );


    });

}


MutNeedles.prototype.drawAxes = function(svg, x, y) {


    xAxis = d3.svg.axis().scale(x).orient("bottom");

    svg.append("svg:g")
      .attr("class", "x-axis")
      .attr("transform", "translate(0," + (this.height - this.buffer) + ")")
      .call(xAxis);

    yAxis = d3.svg.axis().scale(y).orient("left");


    svg.append("svg:g")
      .attr("class", "y-axis")
      .attr("transform", "translate(" + (this.buffer + - 10)  + ",0)")
      .call(yAxis);

    svg.append("text")
      .attr("class", "y-label")
      .attr("text-anchor", "middle")
      .attr("transform", "translate(" + (this.buffer / 3) + "," + (this.height / 2) + "), rotate(-90)")
      .text("Count of mutations @ Coord");

    svg.append("text")
      .attr("class", "x-label")
      .attr("text-anchor", "middle")
      .attr("transform", "translate(" + (this.width / 2) + "," + (this.height - this.buffer / 3) + ")")
      .text("Protein position for Transcript X");
    
}



MutNeedles.prototype.needleHeadColor = function(category, colors) {

    if (category in colors) {
        return this.colors[category];
    } else {
        return "steelblue";
    }
}

MutNeedles.prototype.drawNeedleHeads = function(svg, mutationData, x, y) {

    var maxCoord = this.maxCoord;
    var width = this.width;
    var height = this.height;
    var buffer = this.buffer;
     
    formatCoord = function(coord) {
       if (coord.indexOf("-") > -1) {
            coords = coord.split("-");
            // place neede at middle of affected region
            coord = Math.floor((parseInt(coords[0]) + parseInt(coords[1])) / 2);
        } else {
            coord = parseInt(coord);
        }
        return coord;
    }

    getColor = this.needleHeadColor;
    colors = this.colorMap;
    tip = this.tip;
    
    // stack needles at same pos
    needlePoint = {};
    stackNeedle = function(pos,value) {
      stickHeight = 0;
      if (pos in needlePoint) {
         stickHeight = needlePoint[pos];
         needlePoint[pos] = stickHeight + value;
      } else {
         needlePoint[pos] = value;
      }
      return stickHeight;
    }
    

    d3.tsv(mutationData, function(d) {
        coordString = d.coord;
        numericCoord = formatCoord(d.coord);
        console.log(coordString + " " + numericCoord);
        if (numericCoord > 0) {
            return {
                category: d.category,
                coordString: coordString,
                coord: numericCoord,
                value: +d.value,
                stickHeight: stackNeedle(numericCoord, +d.value)
            }
        } else {
            console.debug("discarding " + d.coord)
        }
    }, function(error, muts) {

        var needles = d3.select(".mutneedles").selectAll()
            .data(muts).enter()
            .append("line")
               .attr("y1", function(data) { return y(data.stickHeight+data.value) })
               .attr("y2", function(data) { return y(data.stickHeight) })
               .attr("x1", function(data) { return x(data['coord']) })
               .attr("x2", function(data) { return x(data['coord']) })
               .attr("class", "needle-line");

      
        var needleHeads = d3.select(".mutneedles").selectAll()
            .data(muts)
          .enter().append("circle")
            .attr("cy", function(data) { return y(data.stickHeight+data.value) } )
            .attr("cx", function(data, index) { return x(data['coord']) } )
            .attr("r", function(data) { return 6; } )
            .style("fill", function(data) {
                    return getColor(data['category'], colors);
                })
            .on('mouseover', tip.show)
            .on('mouseout', tip.hide);

    });
}



categs = {"missense_variant": "lightblue", "frameshift_variant": "blue", "stop_gained": "red", "stop_lost": "orange", "synonymous_variant": "yellow"};
p = new MutNeedles(350, "body", "regions.json", "muts.tsv", categs);


</script>
